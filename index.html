<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Clinic Appointment System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="mb-4 text-center">Clinic Appointment Manager</h1>

    <!-- Book Appointment Button -->
    <div class="d-flex justify-content-end mb-3">
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bookModal">+ Book Appointment</button>
    </div>

    <!-- Appointment Table -->
    <table class="table table-bordered table-striped" id="apptTable">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Patient</th>
          <th>Doctor</th>
          <th>Start</th>
          <th>End</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Modal for Booking -->
  <div class="modal fade" id="bookModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title">Book Appointment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="bookForm">
            <div class="mb-3"><input class="form-control" name="patient_id" placeholder="Patient ID" required></div>
            <div class="mb-3"><input class="form-control" name="doctor_id" placeholder="Doctor ID" required></div>
            <div class="mb-3"><input class="form-control" name="start_time" placeholder="YYYY-MM-DD HH:MM:SS" required></div>
            <div class="mb-3"><input class="form-control" name="end_time" placeholder="YYYY-MM-DD HH:MM:SS" required></div>
            <div class="mb-3"><input class="form-control" name="reason" placeholder="Reason"></div>
            <button class="btn btn-success w-100" type="submit">Confirm Booking</button>
          </form>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
async function loadAppointments() {
  const r = await fetch('/appointments');
  const data = await r.json();
  const tbody = document.querySelector('#apptTable tbody');
  tbody.innerHTML = '';
  data.forEach(a => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${a.appointment_id}</td>
      <td>${a.patient}</td>
      <td>${a.doctor}</td>
      <td>${a.start_time}</td>
      <td>${a.end_time}</td>
      <td>
        <span class="badge bg-${a.status==='completed'?'success':a.status==='cancelled'?'danger':'warning'}">
          ${a.status}
        </span>
      </td>
      <td>
        <button class="btn btn-sm btn-outline-success me-1" onclick="updateStatus(${a.appointment_id}, 'completed')">âœ”</button>
        <button class="btn btn-sm btn-outline-secondary me-1" onclick="updateStatus(${a.appointment_id}, 'cancelled')">âœ–</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteAppt(${a.appointment_id})">ðŸ—‘</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

document.getElementById('bookForm').addEventListener('submit', async e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const obj = Object.fromEntries(fd.entries());
  const res = await fetch('/appointments', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(obj)
  });
  const data = await res.json();
  if(data.error) alert("Error: " + data.error);
  else {
    alert("Appointment booked with ID: " + data.appointment_id);
    e.target.reset();
    loadAppointments();
  }
});

async function updateStatus(id, status) {
  const res = await fetch(/appointments/${id}, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({status})
  });
  const data = await res.json();
  if(data.error) alert("Error: " + data.error);
  else loadAppointments();
}

async function deleteAppt(id) {
  if(!confirm("Delete appointment #" + id + "?")) return;
  const res = await fetch(/appointments/${id}, { method: 'DELETE' });
  const data = await res.json();
  if(data.error) alert("Error: " + data.error);
  else loadAppointments();
}

loadAppointments();
</script>
</body>
</html>